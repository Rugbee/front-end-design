if(typeof(_gat)!="undefined"){var pageTracker=_gat._getTracker("UA-1667048-8")}else{var pageTracker={_trackPageview:function(a){}}}function TripIt(){this.baseUrl=global_baseUrl+"/";this.action="";this.base_action="";this.connections=null;this.currentView;this.viewParams;this.owner;this.referrer;this.has_init_run=false;this.app_actions={"home/account":["mainCanvas",true],"home/whoIsClose":["whoIsClose",true],"home/index":["homePageApp",true],"home/profile":["profilePageApp",false],"account/shareApp":["shareApp",true],"account/updateInstallApp":["install",false],"account/edit":["mainCanvas",false],"trip/create":["createTrip",false],"trip/edit":["editTrip",false]};this.cxnsRequestNumber=1;this.cxnsPerRequest=1000;this.init=function(){tripit.updateProgress(10,"Launching My Travel...");tripit.currentView=gadgets.views.getCurrentView().getName();tripit.viewParams=gadgets.views.getParams();tripit.action=tripit.viewParams.action;if(null!=tripit.action&&"undefined"!=typeof(tripit.action)){tripit.base_action=(tripit.action.indexOf("?")>-1)?tripit.action.substring(0,tripit.action.indexOf("?")):tripit.action;tripit.base_action=tripit.base_action.substring(0,1)=="/"?tripit.base_action.substring(1):tripit.base_action}var post_install_state=tripit.viewParams.post_install_state?tripit.viewParams.post_install_state:0;var referrer=tripit.viewParams.referrer?tripit.viewParams.referrer:"";if(referrer&&referrer!=tripit.currentView){tripit.referrer=referrer}gadgets.window.setTitle("My Travel");switch(tripit.currentView){case"canvas":if((null==tripit.action||"undefined"==tripit.action)&&post_install_state==0){tripit.action="home/account";tripit.base_action="home/account"}else{if((null==tripit.action||"undefined"==tripit.action)&&post_install_state>0){tripit.action="account/updateInstallApp";tripit.base_action="account/updateInstallApp"}}break;case"home":tripit.action="home/index";tripit.base_action="home/index";break;case"profile":tripit.action="home/profile";tripit.base_action="home/profile";break}tripit.has_init_run=true;tripit.getOwnerContext()};this.getOwnerContext=function(){tripit.updateProgress(20,"Launching My Travel...");var req=opensocial.newDataRequest();var requestedFields=[opensocial.Person.Field.ID,opensocial.Person.Field.NAME,opensocial.Person.Field.CURRENT_LOCATION,opensocial.Person.Field.HAS_APP,opensocial.Person.Field.THUMBNAIL_URL,opensocial.Person.Field.PROFILE_URL];var opt={};opt[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]=requestedFields;req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER,opt),"owner");req.send(tripit.initPageRequest)};this.initPageRequest=function(data){tripit.updateProgress(60,"Getting trips from your connections...");tripit.owner=data.get("owner").getData();if(null==tripit.owner||"undefined"==typeof(tripit.owner)){tripit.loadTripItOwnerErrorPage()}else{var are_cxns_needed=tripit.app_actions[tripit.base_action][1];if(are_cxns_needed&&tripit.owner.isViewer()){tripit.doRequest("account/hasSocialGraph?osid="+tripit.owner.getId(),null,tripit.getSocialData)}else{tripit.doRequest(tripit.action,null,tripit.paintCanvas)}}};this.getSocialData=function(request_response){tripit.updateProgress(80,"Sharing trips with your connections...");var json_response=request_response.text;if(json_response!="undefined"&&json_response!=""){var obj=eval("obj="+json_response);if(typeof(obj.result_string)!="undefined"&&obj.result_string=="false"){var req=opensocial.newDataRequest();for(var i=0;i<tripit.cxnsRequestNumber;i++){var opt={};opt[opensocial.DataRequest.PeopleRequestFields.FIRST]=tripit.cxnsPerRequest*i+1;opt[opensocial.DataRequest.PeopleRequestFields.MAX]=tripit.cxnsPerRequest*i+tripit.cxnsPerRequest;var requestedFields=[opensocial.Person.Field.ID,opensocial.Person.Field.NAME,opensocial.Person.Field.CURRENT_LOCATION,opensocial.Person.Field.HAS_APP,opensocial.Person.Field.THUMBNAIL_URL,opensocial.Person.Field.PROFILE_URL];opt[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]=requestedFields;req.add(req.newFetchPeopleRequest(opensocial.newIdSpec({userId:"OWNER",groupId:"FRIENDS"}),opt),"cxns_"+i)}req.send(tripit.doSocialRequest)}else{if(typeof(obj.result_string)!="undefined"&&obj.result_string=="true"){tripit.doSocialRequest(false)}else{tripit.paintCanvas(obj)}}}else{tripit.paintCanvas({text:""})}};this.doSocialRequest=function(social_data){tripit.updateProgress(90,"We're almost done...");var share_app=tripit.viewParams.share_app;if(social_data){for(var i=0;i<tripit.cxnsRequestNumber;i++){var cxns=social_data.get("cxns_"+i).getData();if(cxns!=null&&typeof(cxns)=="object"){cxns.each(tripit.setPerson)}}}if(share_app=="1"){tripit.shareApplication()}else{tripit.doRequest(tripit.baseUrl+tripit.action,tripit.connections?{cxns:JSON.stringify(tripit.connections)}:null,tripit.paintCanvas)}};this.setPerson=function(person){if(typeof(person)!="undefined"){var osid=person.getField(opensocial.Person.Field.ID);var parsedPerson={display_name:person.getDisplayName(),profile_url:person.getField(opensocial.Person.Field.PROFILE_URL),photo_url:person.getField(opensocial.Person.Field.THUMBNAIL_URL),has_app:person.getField(opensocial.Person.Field.HAS_APP),home_loc:""};var currentLocation=person.getField(opensocial.Person.Field.CURRENT_LOCATION);if(typeof(currentLocation)!="undefined"){parsedPerson.home_loc=currentLocation.getField("formatted")}if(tripit.connections){tripit.connections[osid]=parsedPerson}else{tripit.connections={};tripit.connections[osid]=parsedPerson}}};this.updateProgress=function(percent_complete,message){var progressElement=document.getElementById("tripit_progress");if(!progressElement){var progressElement=document.createElement("div");progressElement.setAttribute("id","tripit_progress");progressElement.setAttribute("class","txtAgnCnt alignVMid fnt14 fntMdGry");progressElement.setAttribute("style","margin-top:20px auto 0 auto; width:100%;");document.getElementById("tripit_gadget_container").appendChild(progressElement)}progressElement.innerHTML=percent_complete+"%: "+message};this.sendShareAppMessage=function(connections){var subject="See my upcoming trips";var body="Hi,\n\nLet's keep up with each other's travel plans. Click below to add the My Travel Application by TripIt to your LinkedIn profile:\n\n<a href=\""+global_installUrl+'">'+global_installUrl+'</a>\n\nYou\'ll automatically see when your trips might cross paths with your LinkedIn contacts.\n\nThe Wall Street Journal calls TripIt "addictive."  Daily Candy calls it "easy and damn useful." I think you\'ll like it.';tripit.sendMessage(connections,subject,body)};this.sendMessage=function(cxns,subject,body){var params=[];params[opensocial.Message.Field.TITLE]=subject;var message=opensocial.newMessage(body,params);var recipients=opensocial.newIdSpec({userId:cxns});var args=[];var canvasView=new gadgets.views.View("canvas");var destination=new opensocial.NavigationParameters({owner:tripit.owner,view:canvasView});args[opensocial.NavigationParameters.DestinationType.VIEWER_DESTINATION]=destination;opensocial.requestSendMessage(recipients,message,undefined,args)};this.doRequest=function(action,postdata,callback){var params={};if(postdata){params[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;params[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(postdata)}params[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.TEXT;params[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var ts=new Date().getTime();var sep=(action.indexOf("?")>-1)?"&":"?";action=[action,sep,"nocache=",ts].join("");var curr_location=tripit.owner.getField(opensocial.Person.Field.CURRENT_LOCATION);if(typeof(curr_location)!="undefined"){var home_location=curr_location.getField("formatted")}else{var home_location=""}var request_params={owner_id:tripit.owner.getId(),is_viewer_owner:tripit.owner.isViewer()?"1":"0",owner_name:tripit.owner.getDisplayName(),owner_thumbnail:tripit.owner.getField(opensocial.Person.Field.THUMBNAIL_URL),owner_profile:tripit.owner.getField(opensocial.Person.Field.PROFILE_URL),home_location:home_location,are_cxns_needed:tripit.app_actions[tripit.base_action][1]?1:0};action+="&"+gadgets.io.encodeValues(request_params);if(action.indexOf(tripit.baseUrl)!==0){action=tripit.baseUrl+action}gadgets.io.makeRequest(action,(typeof(callback)=="function")?callback:tripit.paintCanvas,params)};this.navigateTo=function(view,params){var destView=new gadgets.views.View(view);if(typeof(params)!="object"){var params={}}params.referrer=gadgets.views.getCurrentView().getName();gadgets.views.requestNavigateTo(destView,params)};this.goBack=function(){if(typeof(tripit.referrer)!="undefined"&&tripit.referrer!=tripit.currentView){tripit.navigateTo(tripit.referrer)}else{tripit.navigateTo(tripit.currentView)}};this.submitForm=function(action,form,callback){if(typeof form=="undefined"){form=document}var postdata={};var fields={input:form.getElementsByTagName("INPUT"),select:form.getElementsByTagName("SELECT"),textarea:form.getElementsByTagName("TEXTAREA"),button:form.getElementsByTagName("BUTTON")};for(var tag in fields){for(var i=0;i<fields[tag].length;i++){field=fields[tag][i];if(typeof field=="object"){if(field.name.substr(field.name.lastIndexOf("_"),(field.name.length-field.name.lastIndexOf("_")))!="_ph"&&field.value!==""){if(tag=="input"){if(field.type.toUpperCase() in {CHECKBOX:"",RADIO:""}){if(field.checked){postdata[field.name]=field.value}}else{postdata[field.name]=field.value}}else{if(tag=="select"){postdata[field.name]=field.options[field.selectedIndex].value}else{if(tag=="textarea"){postdata[field.name]=field.value}}}}}}}for(key in postdata){if(typeof(postdata[key])==="string"){postdata[key]=postdata[key].replace(/^\s+|\s+$/g,"")}}tripit.doRequest(action,postdata,callback)};this.submitFormToggleBtnState=function(){$("#submitBtn").toggle();$("#submitLoading").toggle()};this.generateTimeoutPage=function(){var timeoutUrl="http://www.linkedin.com/home";switch(tripit.currentView){case"canvas":var view=new gadgets.views.View("canvas");var urlTemplate=view.getUrlTemplate();var timeoutUrl=view.bind(tripit.viewParams);break;case"profile":if(null!=tripit.owner&&"undefined"!=typeof(tripit.owner)){var timeoutUrl=tripit.owner.getField(opensocial.Person.Field.PROFILE_URL)}break}tripit.base_action="timeOutPage:"+tripit.app_actions[tripit.base_action][0];return'We\'re sorry but the My Travel application had trouble communicating with the server due to high load.  Please try again later.<br /><br />[<a target="_top" href="'+timeoutUrl+'">Click here to try again.</a>]'};this.paintCanvas=function(obj){var str=(obj.text=="")?tripit.generateTimeoutPage():obj.text;var container=document.getElementById("tripit_gadget_container");container.innerHTML=str;runScripts(container);var pageTrackerLabel=(tripit.base_action in tripit.app_actions)?tripit.app_actions[tripit.base_action][0]:tripit.base_action;pageTracker._trackPageview(pageTrackerLabel);tripit.has_init_run=false;gadgets.window.adjustHeight();setTimeout(function(){gadgets.window.adjustHeight()},1000)};this.loadTripItOwnerErrorPage=function(){var str="We're sorry but the LinkedIn servers are experiencing unusually high load at the moment.  Please try again later.";pageTracker._trackPageview("tripitOwnerErrorPage");document.getElementById("tripit_gadget_container").innerHTML=str;gadgets.window.adjustHeight()};this.shareApplication=function(){if(tripit.currentView=="canvas"){tripit.action="account/shareApp?is_canvas_view=true";tripit.base_action="account/shareApp";if(tripit.has_init_run==false){tripit.getOwnerContext()}else{tripit.doRequest(tripit.action,tripit.connections?{cxns:JSON.stringify(tripit.connections)}:null,tripit.paintCanvas)}}else{gadgets.views.requestNavigateTo(new gadgets.views.View("canvas"),{share_app:"1"})}};this.getShareAppSelection=function(){var frm=document.getElementById("fmCxn");var checkboxes=frm.getElementsByTagName("input");var cxns_checked=new Array();for(var i=0;i<checkboxes.length;i++){if(checkboxes[i].type=="checkbox"&&checkboxes[i].checked){cxns_checked.push(checkboxes[i].value)}}return cxns_checked};this.submitShareApp=function(){var selection=tripit.getShareAppSelection();if(selection.length>0){tripit.sendShareAppMessage(selection)}else{cxns.reset();tripit.goBack()}};this.createEditTrip_callback=function(response_obj){var json_response=response_obj.text;if(json_response!="undefined"&&json_response!=""){var obj=eval("obj="+json_response);if(typeof(obj.form_errors)!="undefined"&&obj.form_errors.length>0){tripit.submitFormToggleBtnState();tripit.displayErrors(obj);return false}else{var params={};if(typeof(obj.redirect_url)=="string"){params.action=obj.redirect_url}tripit.navigateTo("canvas",params)}}else{tripit.navigateTo("canvas",{action:"home/account"})}};this.installAppBtn_onclick=function(){var params=gadgets.views.getParams();var post_install_state=params.post_install_state;document.getElementById("is_profile_install").value=(post_install_state==2||post_install_state==3)?"1":"0";document.getElementById("is_homepage_install").value=(post_install_state==1||post_install_state==3)?"1":"0";if(document.fmTrip.is_new_user[0].checked==true){document.getElementById("email_address_old").value="";document.getElementById("password").value="";var req=opensocial.newDataRequest();var requestedFields=[opensocial.Person.Field.EMAILS];var opt={};opt[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]=requestedFields;req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER,opt),"owner");req.send(tripit.getEmails_callback)}else{if(document.fmTrip.is_new_user[1].checked==true){document.getElementById("email_address_new").value="";tripit.submitForm("account/updateInstallApp",document.getElementById("fmTrip"),tripit.installAppBtn_callback)}else{tripit.submitFormToggleBtnState()}}};this.getEmails_callback=function(data){var res=data.get("owner").getData().fields_.emails;var emails_val="";for(var i=0;i<res.length;i++){emails_val+=res[i].fields_.value;if(i+1!=res.length){emails_val+="|"}}document.getElementById("email_addresses").value=emails_val;tripit.submitForm("account/updateInstallApp",document.getElementById("fmTrip"),tripit.installAppBtn_callback)};this.installAppBtn_callback=function(response_obj){var json_response=response_obj.text;if(json_response!="undefined"&&json_response!=""){var obj=eval("obj="+json_response);if(typeof(obj.form_errors)!="undefined"&&obj.form_errors.length>0){tripit.submitFormToggleBtnState();tripit.displayErrors(obj);return false}else{tripit.navigateTo("canvas",{action:obj.redirect_url})}}else{tripit.doRequest("home/account",null,tripit.paintCanvas)}};this.createAcctSet_callback=function(){tripit.doRequest("home/account",null,tripit.paintCanvas)};this.resendConfEmail=function(){tripit.doRequest("account/sendConfirmationEmail",null,tripit.resendConfEmail_callback)};this.resendConfEmail_callback=function(obj){$(".modal").dialog("close");tripit.init_modal("confirmation","250","")};this.sendConfEmail=function(){tripit.doRequest("account/sendConfirmationEmail",null,tripit.sendConfEmail_callback)};this.sendConfEmail_callback=function(obj){document.getElementById("send_email_cta").innerHTML="Mail sent!"};this.showUnconfirmedModal=function(){tripit.init_modal("unconfirmed","260","")};this.showSettingsModal=function(){tripit.init_modal("settings","260","")};this.displayErrors=function(err){if(typeof(err.form_errors)!="undefined"){var target=document.getElementById("err_"+err.field_name);if(target==null){target=document.getElementById("err_general")}var errDiv=document.createElement("div");var ul=document.createElement("ul");var li=document.createElement("li");li.innerHTML="Error";ul.appendChild(li);for(var i=0;i<err.form_errors.length;++i){var li=document.createElement("li");li.innerHTML=err.form_errors[i].error_message;ul.appendChild(li)}errDiv.appendChild(ul);var message=new gadgets.MiniMessage("tripit",target);message.createTimerMessage(errDiv,6)}};this.debug=function(obj){console.debug(obj)};this.init_modal=function(name,width,close){$(function(){$("#"+name+"_modal_dialog").dialog({modal:true,width:width,height:"auto"});$(".ui-widget-overlay").css({opacity:"0"});$(".ui-widget-overlay").click(function(){$("#"+name+"_modal_dialog").dialog("close")})})};this.ckUnckAll=function(state){var _arr=new Array();var _arr=document.getElementById("fmCxn").elements;for(i=0;i<_arr.length;i++){if(_arr[i].type=="checkbox"){_arr[i].checked=state}}};this.displayLoading=function(target_id){}}function runScripts(e){if(e.nodeType!=1){return}if(e.tagName.toLowerCase()=="script"){eval(e.text)}else{var n=e.firstChild;while(n){if(n.nodeType==1){runScripts(n)}n=n.nextSibling}}}function __toggle_(c,d,a,f){var e=document.getElementById(c);var b=document.getElementById(d);if(b.style.display=="none"){b.style.display="block";e.innerHTML=f}else{b.style.display="none";e.innerHTML=a}gadgets.window.adjustHeight()}function Cxns(){this.max=50;this.current=0;this.onclick=function(a){if(a.checked){if(this.current<this.max){this.current++}else{a.checked=false;document.getElementById("cxns_max").innerHTML=this.max;tripit.init_modal("exc_max","260","")}}else{this.current--}this.refresh()};this.refresh=function(){document.getElementById("connections_left").innerHTML=this.max-this.current};this.reset=function(){this.current=0}}var tripit=new TripIt();var cxns=new Cxns();var olh=gadgets.util.registerOnLoadHandler(tripit.init);